<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>YouTube to MP3 Extractor</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="toastNotification"></div>

  <div class="container">
    <h1>🚀 YouTube to MP3 Extractor</h1>
    <div class="input-container">
      <input type="text" id="urlInput" placeholder="Paste YouTube link..." required />
      <button onclick="fetchVideoInfo()">Extract</button>
    </div>
    
    <p id="status"></p>

    <div id="detailsContainer">
        <div id="skeletonLoader">
            <div class="skeleton skeleton-thumbnail"></div>
            <div class="skeleton-info">
                <div class="skeleton skeleton-text"></div>
                <div class="skeleton skeleton-text short"></div>
                <div class="skeleton skeleton-buttons"></div>
            </div>
        </div>
        <div id="detailsContent" style="display: none;">
            <img id="thumbnail" src="" alt="Video Thumbnail">
            <div class="info">
                <h3 id="videoTitle"></h3>
                <p id="videoArtist"></p>
                <div id="qualityButtons"></div>
                <button id="previewButton" onclick="startPreview()">Preview</button>
                <div id="progressContainer" class="progress-container" style="display: none;">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="libraryContainer">
        <h3>Preview Library</h3>
        <hr>
        <div id="downloadsList">
            <p>No previews loaded yet.</p>
        </div>
    </div>
  </div>

  <footer>
    <p>© 2025 Carnage Sentinels</p>
  </footer>

  <script>
    let previewLibrary = [];
    let currentVideoData = {};
    let currentlyPlayingAudio = null;
    let selectedFormatId = null;
    let toastTimeout;
    let progressInterval;

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toastNotification');
        toast.textContent = message;
        toast.className = '';
        toast.classList.add(type, 'show');
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
            toast.classList.remove('show');
        }, 5000);
    }

    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function renderPreviewLibrary() {
        const downloadsList = document.getElementById('downloadsList');
        downloadsList.innerHTML = '';

        if (previewLibrary.length === 0) {
            downloadsList.innerHTML = '<p>No previews loaded yet.</p>';
            return;
        }

        previewLibrary.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'download-item';
            const playerId = `player-${index}`;
            const audioBlobUrl = URL.createObjectURL(item.blob);

            itemDiv.innerHTML = `
                <img src="${item.metadata.thumbnail}" alt="thumbnail" class="thumbnail-small">
                <div class="item-info">
                    <strong>${item.metadata.title}</strong>
                    <p>${item.metadata.artist}</p>
                    <div class="custom-audio-player" id="${playerId}">
                        <audio src="${audioBlobUrl}" preload="metadata"></audio>
                        <button class="play-pause-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="play-icon"><path d="M8 5v14l11-7z"/></svg>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pause-icon" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </button>
                        <span class="time-current">0:00</span>
                        <input type="range" class="progress-bar" value="0" max="100">
                        <span class="time-duration">0:00</span>
                    </div>
                </div>
                <div class="item-controls">
                    <button onclick="downloadPreview(${index})">Download</button>
                    <button onclick="deletePreview(${index})">Delete</button>
                </div>
            `;
            downloadsList.appendChild(itemDiv);
            initializePlayer(playerId);
        });
    }
    
    function initializePlayer(playerId) {
        const player = document.getElementById(playerId);
        const audio = player.querySelector('audio');
        const playPauseBtn = player.querySelector('.play-pause-btn');
        const playIcon = player.querySelector('.play-icon');
        const pauseIcon = player.querySelector('.pause-icon');
        const progressBar = player.querySelector('.progress-bar');
        const currentTimeEl = player.querySelector('.time-current');
        const durationEl = player.querySelector('.time-duration');
        playPauseBtn.addEventListener('click', () => {
            if (audio.paused) {
                if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
                    currentlyPlayingAudio.pause();
                }
                audio.play();
                currentlyPlayingAudio = audio;
            } else {
                audio.pause();
                currentlyPlayingAudio = null;
            }
        });
        audio.addEventListener('play', () => { playIcon.style.display = 'none'; pauseIcon.style.display = 'block'; });
        audio.addEventListener('pause', () => { playIcon.style.display = 'block'; pauseIcon.style.display = 'none'; });
        audio.addEventListener('loadedmetadata', () => { progressBar.max = audio.duration; durationEl.textContent = formatTime(audio.duration); });
        audio.addEventListener('timeupdate', () => { progressBar.value = audio.currentTime; currentTimeEl.textContent = formatTime(audio.currentTime); });
        progressBar.addEventListener('input', () => { audio.currentTime = progressBar.value; });
        audio.addEventListener('ended', () => { currentlyPlayingAudio = null; });
    }

    function deletePreview(index) {
        if (confirm(`Are you sure you want to remove this preview?`)) {
            previewLibrary.splice(index, 1);
            renderPreviewLibrary();
        }
    }

    function downloadPreview(index) {
        const item = previewLibrary[index];
        const link = document.createElement('a');
        link.href = URL.createObjectURL(item.blob);
        link.download = `${item.metadata.title}.mp3`;
        document.body.appendChild(link);
        link.click();
        link.remove();
        showToast("✅ Download started!", "success");
    }

    async function fetchVideoInfo() {
        const urlInput = document.getElementById("urlInput");
        const url = urlInput.value.trim();
        const detailsContainer = document.getElementById("detailsContainer");
        const skeletonLoader = document.getElementById("skeletonLoader");
        const detailsContent = document.getElementById("detailsContent");

        if (!url) {
            showToast("⚠️ Please paste a valid YouTube URL.", "error");
            return;
        }
        
        showToast("⏳ Fetching video details...");
        detailsContent.style.display = 'none';
        skeletonLoader.style.display = 'flex';
        detailsContainer.style.display = 'flex';
        
        try {
            const response = await fetch('/get-info', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url })
            });
            if (!response.ok) throw new Error("Failed to fetch video info.");

            const data = await response.json();
            currentVideoData = data;

            document.getElementById('thumbnail').src = data.thumbnail;
            document.getElementById('videoTitle').textContent = data.title;
            document.getElementById('videoArtist').textContent = data.artist;

            const qualityButtonsContainer = document.getElementById('qualityButtons');
            qualityButtonsContainer.innerHTML = '';

            data.audio_formats.forEach((format, index) => {
                if (index === 0) selectedFormatId = format.format_id;
                const button = document.createElement('button');
                button.className = `quality-button ${index === 0 ? 'selected' : ''}`;
                button.dataset.formatId = format.format_id;
                button.textContent = `${format.quality} (${format.ext}) - ${format.size}`;
                button.onclick = () => selectQuality(button);
                qualityButtonsContainer.appendChild(button);
            });

            skeletonLoader.style.display = 'none';
            detailsContent.style.display = 'flex';
        } catch (err) {
            showToast("❌ Error: " + err.message, "error");
            detailsContainer.style.display = 'none';
        }
    }

    function selectQuality(buttonElement) {
        const buttons = document.querySelectorAll('.quality-button');
        buttons.forEach(btn => btn.classList.remove('selected'));
        buttonElement.classList.add('selected');
        selectedFormatId = buttonElement.dataset.formatId;
    }
async function startPreview() {
    const url = document.getElementById("urlInput").value.trim();
    const previewButton = document.getElementById('previewButton');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const detailsContainer = document.getElementById('detailsContainer');
    const detailsContent = document.getElementById('detailsContent');

    if (!url || !selectedFormatId) {
        showToast("⚠️ Could not start preview. Please select a quality.", "error");
        return;
    }

    previewButton.disabled = true;
    previewButton.innerHTML = `Loading...`;
    progressContainer.style.display = 'block';
    progressFill.style.width = '0%';

    // Add fade-out class if visible, before starting the progress
    detailsContainer.classList.remove('fade-out');
    detailsContainer.classList.add('fade-in');
    detailsContainer.style.display = 'flex';

    let progress = 0;
    let increment = 0.5;

    progressInterval = setInterval(() => {
        if (progress < 95) {
            increment = 0.5 + (progress / 100) * 2; // Accelerate over time
            progress = Math.min(progress + increment, 95);
            progressFill.style.width = progress + '%';
        }
    }, 100);

    try {
        const response = await fetch('/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                url: url,
                format_id: selectedFormatId,
                metadata: {
                    title: currentVideoData.title,
                    artist: currentVideoData.artist,
                    thumbnail: currentVideoData.thumbnail
                }
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.details || "Download failed on the server.");
        }

        const blob = await response.blob();

        clearInterval(progressInterval);
        progressFill.style.width = '100%';

        previewLibrary.push({
            metadata: currentVideoData,
            blob: blob
        });

        renderPreviewLibrary();
        showToast("✅ Preview loaded!", "success");

        document.getElementById("urlInput").value = "";

        // Smoothly fade out the details container
        detailsContainer.classList.remove('fade-in');
        detailsContainer.classList.add('fade-out');
        detailsContainer.addEventListener('animationend', () => {
            detailsContainer.style.display = 'none';
            detailsContainer.classList.remove('fade-out');
        }, { once: true });

    } catch (err) {
        clearInterval(progressInterval);
        showToast("❌ Error: " + err.message, "error");
    } finally {
        previewButton.disabled = false;
        previewButton.innerHTML = 'Preview';
        progressContainer.style.display = 'none';
    }
}
  </script>
</body>
</html>
